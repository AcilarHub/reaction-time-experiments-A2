<html>

<head>
    <title>Human Capabilities – Decision Reaction Time</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: white;
            margin: 0;
            overflow: hidden;
            text-align: center;

        }

        #stimulus {
            position: absolute;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>A.2 Decision Reaction Time</h1>

    <div id="demographics">
        <h2>Demographic Data</h2>
        <label>Age: <input type="number" id="age" required></label><br><br>
        <label>Gender:
            <select id="gender">
                <option value="">--Select--</option>
                <option value="female">Female</option>
                <option value="male">Male</option>
                <option value="other">Other</option>
            </select>
        </label><br><br>
        <label>Nationality: <input type="text" id="nationality" required></label><br><br>
        <button onclick="startExperiment()">Start Test</button>
    </div>

    <div id="experiment" class="hidden">
        <h1 id="title">User Study</h1>
        <h2 id="instruction">Press space to start!</h2>
        <div id="stimulus"></div>
        <p id="time"></p>
        <p id="count"></p>
        <p id="mean"></p>
        <p id="sd"></p>
        <p id="error"></p>
        <p id="orangeStats"></p>
        <p id="purpleStats"></p>
    </div>
    </div>

    <div id="final-results" class="hidden">
        <h2>Results</h2>
        <pre id="result-output"></pre>
        <button onclick="downloadResults()">Download Results</button>
    </div>

    <script>
        let experimentActive = false;
        let stimulusIsVisible = false;
        let stimulusTimestamp;
        let testStimulusTimeout;
        let triangleTimeout;
        let trialCount = 0;
        const maxTrials = 30;

        let times = [];
        let timesOrange = [];
        let timesPurple = [];
        let errors = 0;

        let isSquare = false;
        let currentColor = "";

        const stimulus = document.getElementById("stimulus");
        const instruction = document.getElementById("instruction");
        const timeDisplay = document.getElementById("time");
        const countDisplay = document.getElementById("count");
        const meanDisplay = document.getElementById("mean");
        const sdDisplay = document.getElementById("sd");
        const errorDisplay = document.getElementById("error");
        const orangeStats = document.getElementById("orangeStats");
        const purpleStats = document.getElementById("purpleStats");

        function getMean(data) {
            const sum = data.reduce((a, b) => a + b, 0);
            return sum / data.length;
        }

        function getStandardDeviation(data) {
            const mean = getMean(data);
            const variance = data.reduce((a, b) => a + (b - mean) ** 2, 0) / data.length;
            return Math.sqrt(variance);
        }

        function clearResults() {
            timeDisplay.textContent = '';
            countDisplay.textContent = '';
            meanDisplay.textContent = '';
            sdDisplay.textContent = '';
            errorDisplay.textContent = '';
            orangeStats.textContent = '';
            purpleStats.textContent = '';
        }

        function startExperiment() {
            const age = document.getElementById('age').value;
            const gender = document.getElementById('gender').value;
            const nationality = document.getElementById('nationality').value;

            if (!age || !gender || !nationality) {
                alert("Please complete all demographic fields.");
                return;
            }

            demographics = { age, gender, nationality };

            document.getElementById('demographics').classList.add('hidden');
            document.getElementById('experiment').classList.remove('hidden');
            clearResults();
            trialCount = 0;
            times = [];
            timesOrange = [];
            timesPurple = [];
            errors = 0;
            experimentActive = true;
            instruction.textContent = "Press space if a square appears!";
            scheduleNextStimulus();
        }

        function scheduleNextStimulus() {
            stimulus.style.left = "-9999px";
            const waitTime = Math.random() * 4 + 2; // 2–6 sec
            testStimulusTimeout = setTimeout(showStimulus, waitTime * 1000);
        }

        function showStimulus() {
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const size = 100 + Math.random() * 200;

            const x = Math.random() * (screenWidth - size);
            const y = Math.random() * (screenHeight - size);

            stimulus.style.width = size + "px";
            stimulus.style.height = size + "px";
            stimulus.style.left = x + "px";
            stimulus.style.top = y + "px";

            isSquare = Math.random() < 0.5;
            currentColor = Math.random() < 0.5 ? "orange" : "purple";
            stimulus.style.backgroundColor = currentColor;

            if (isSquare) {
                stimulus.style.clipPath = "none";
            } else {
                stimulus.style.clipPath = "polygon(50% 0%, 0% 100%, 100% 100%)";
            }

            stimulusTimestamp = Date.now();
            stimulusIsVisible = true;

            if (!isSquare) {
                triangleTimeout = setTimeout(() => {
                    stimulusIsVisible = false;
                    trialCount++;
                    if (trialCount >= maxTrials) {
                        stopExperiment();
                    } else {
                        scheduleNextStimulus();
                    }
                }, (1000 + Math.random() * 3000));
            }
        }

        function recordReactionTime() {
            const delta = Date.now() - stimulusTimestamp;
            times.push(delta);
            timeDisplay.textContent = delta + " ms";

            if (currentColor === "orange") timesOrange.push(delta);
            if (currentColor === "purple") timesPurple.push(delta);

            trialCount++;
            stimulusIsVisible = false;
            stimulus.style.left = "-9999px";

            if (trialCount >= maxTrials) {
                stopExperiment();
            } else {
                scheduleNextStimulus();
            }
        }

        function stopExperiment() {
            clearTimeout(testStimulusTimeout);
            clearTimeout(triangleTimeout);
            stimulusIsVisible = false;
            experimentActive = false;
            instruction.textContent = "Press space to start!";

            const mean = getMean(times) || 0;
            const sd = getStandardDeviation(times) || 0;
            const errorRate = ((errors / maxTrials) * 100).toFixed(2);

            countDisplay.textContent = `Count: ${trialCount}`;
            meanDisplay.textContent = `Mean RT: ${Math.round(mean)} ms`;
            sdDisplay.textContent = `SD: ${Math.round(sd)} ms`;
            errorDisplay.textContent = `Errors: ${errors} (${errorRate}%)`;

            let output = `--- Demographic Info ---\n`;
            output += `Age: ${demographics.age}\nGender: ${demographics.gender}\nNationality: ${demographics.nationality}\n\n`;
            output += `Trials: ${times.length}\nMean: ${Math.round(mean)} ms\nSD: ${Math.round(sd)} ms\nErrors: ${errors} (${errorRate}%)\n`;

            document.getElementById('result-output').textContent = output;

            document.getElementById('experiment').classList.add('hidden');
            document.getElementById('final-results').classList.remove('hidden');

        }

        window.addEventListener("keydown", (e) => {
            if (e.key === " ") {
                if (!experimentActive) {
                    startExperiment();
                } else if (stimulusIsVisible) {
                    if (isSquare) {
                        recordReactionTime();
                    } else {
                        errors++;
                        stimulusIsVisible = false;
                        stimulus.style.left = "-9999px";
                        clearTimeout(triangleTimeout);
                        trialCount++;
                        if (trialCount >= maxTrials) {
                            stopExperiment();
                        } else {
                            scheduleNextStimulus();
                        }
                    }
                } else {
                    errors++;
                }
            } else if (e.key === "a" && trialCount >= maxTrials) {
    if (experimentActive) {
        stopExperiment();
    }
}
        });

        function downloadResults() {
            const data = document.getElementById('result-output').textContent;
            const blob = new Blob([data], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reaction_results_${demographics.nationality}_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>

</html>
